<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Encrypted Messenger</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f0f2f5;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .container {
            width: 100%;
            max-width: 500px;
            height: 100vh;
            max-height: 800px;
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }

        /* Landing Page */
        .landing {
            padding: 40px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            height: 100%;
        }

        .landing h1 {
            font-size: 28px;
            margin-bottom: 10px;
            color: #1a1a1a;
        }

        .landing p {
            color: #666;
            margin-bottom: 30px;
        }

        .landing button {
            background: #0084ff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 24px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .landing button:hover {
            background: #0073e6;
        }

        .share-link {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            word-break: break-all;
            font-family: monospace;
            font-size: 14px;
        }

        /* Chat Interface */
        .chat {
            display: none;
            flex-direction: column;
            height: 100%;
        }

        .chat-header {
            background: #fff;
            padding: 16px 20px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .chat-header h2 {
            font-size: 18px;
            font-weight: 600;
        }

        .user-count {
            font-size: 14px;
            color: #666;
        }

        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f0f2f5;
        }

        .message {
            margin-bottom: 12px;
            display: flex;
            align-items: flex-end;
        }

        .message.own {
            flex-direction: row-reverse;
        }

        .message-content {
            max-width: 70%;
            padding: 8px 12px;
            border-radius: 18px;
            background: #e4e6eb;
            color: #000;
            word-wrap: break-word;
        }

        .message.own .message-content {
            background: #0084ff;
            color: white;
        }

        .message-info {
            font-size: 11px;
            color: #666;
            margin: 0 8px;
        }

        .message.own .message-info {
            text-align: right;
        }

        .chat-input {
            padding: 16px;
            background: #fff;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .chat-input input {
            flex: 1;
            padding: 10px 16px;
            border: 1px solid #e0e0e0;
            border-radius: 24px;
            outline: none;
            font-size: 15px;
        }

        .chat-input input:focus {
            border-color: #0084ff;
        }

        .chat-input button {
            background: #0084ff;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .chat-input button:hover {
            background: #0073e6;
        }

        .chat-input button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .key-input {
            padding: 20px;
            background: #fff8dc;
            border-bottom: 1px solid #e0e0e0;
            text-align: center;
        }

        .key-input input {
            padding: 8px 16px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 0 8px;
            font-family: monospace;
        }

        .key-input button {
            padding: 8px 16px;
            background: #4caf50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .error-message {
            color: #d32f2f;
            font-size: 14px;
            margin-top: 8px;
        }

        .system-message {
            text-align: center;
            color: #666;
            font-size: 13px;
            margin: 12px 0;
            font-style: italic;
        }

        @media (max-width: 600px) {
            .container {
                max-height: 100vh;
                border-radius: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Landing Page -->
        <div id="landing" class="landing">
            <h1>Encrypted Messenger</h1>
            <p>Create a secure room for up to 4 people. Messages are encrypted with your shared secret key.</p>
            <button onclick="createRoom()">Create New Room</button>
            <div id="roomLink" style="display:none;">
                <p style="margin-top: 20px;">Share this link with your friends:</p>
                <div class="share-link" id="shareLink"></div>
                <button onclick="copyLink()" style="margin-top: 10px;">Copy Link</button>
            </div>
        </div>

        <!-- Chat Interface -->
        <div id="chat" class="chat">
            <div class="chat-header">
                <h2>Encrypted Room</h2>
                <span class="user-count" id="userCount">1 user</span>
            </div>
            
            <div class="key-input" id="keyInput">
                <span>Enter your shared key:</span>
                <input type="password" id="encryptionKey" placeholder="Secret key">
                <button onclick="setKey()">Set Key</button>
                <div class="error-message" id="keyError"></div>
            </div>

            <div class="messages" id="messages">
                <div class="system-message">Welcome! Set your encryption key to start chatting.</div>
            </div>

            <div class="chat-input">
                <input type="text" id="messageInput" placeholder="Type a message..." disabled>
                <button onclick="sendMessage()" id="sendButton" disabled>
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let roomId = null;
        let userId = null;
        let userNumber = null;
        let encryptionKey = null;
        let messages = [];

        // Check if joining existing room
        const urlParams = new URLSearchParams(window.location.search);
        const joinRoomId = urlParams.get('room');
        if (joinRoomId) {
            joinRoom(joinRoomId);
        }
        
        // Initialize WebSocket on page load
        window.addEventListener('load', () => {
            if (roomId) {
                connectWebSocket();
            }
        });

        // Create new room
        function createRoom() {
            roomId = generateRoomId();
            userId = generateUserId();
            
            const roomLink = `${window.location.origin}${window.location.pathname}?room=${roomId}`;
            document.getElementById('shareLink').textContent = roomLink;
            document.getElementById('roomLink').style.display = 'block';
            
        }

        // Join existing room
        function joinRoom(id) {
            roomId = id;
            userId = generateUserId();
            
            document.getElementById('landing').style.display = 'none';
            document.getElementById('chat').style.display = 'flex';
            
            // Connect to WebSocket
            connectWebSocket();
        }

        // Set encryption key
        function setKey() {
            const keyInput = document.getElementById('encryptionKey');
            const key = keyInput.value.trim();
            
            if (!key) {
                document.getElementById('keyError').textContent = 'Please enter a key';
                return;
            }
            
            encryptionKey = key;
            document.getElementById('keyInput').style.display = 'none';
            document.getElementById('messageInput').disabled = false;
            document.getElementById('sendButton').disabled = false;
            document.getElementById('messageInput').focus();
            
            addSystemMessage('Encryption key set. You can now send encrypted messages.');
        }

        // Send message
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message || !encryptionKey || !ws || ws.readyState !== WebSocket.OPEN) return;
            
            const encrypted = await encryptMessage(message, encryptionKey);
            
            const messageObj = {
                id: Date.now(),
                userId: userId,
                userNumber: userNumber,
                encrypted: encrypted,
                timestamp: new Date()
            };
            
            // Send via WebSocket
            ws.send(JSON.stringify({
                type: 'message',
                encrypted: encrypted
            }));
            
            // Add to local messages and display immediately
            messages.push(messageObj);
            displayMessage(messageObj, message);
            
            // Clear input
            input.value = '';
        }

        // Display message
        function displayMessage(messageObj, decryptedText = null) {
            const messagesEl = document.getElementById('messages');
            const messageEl = document.createElement('div');
            messageEl.className = `message ${messageObj.userId === userId ? 'own' : ''}`;
            
            const time = new Date(messageObj.timestamp).toLocaleTimeString([], { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            if (decryptedText) {
                messageEl.innerHTML = `
                    <div class="message-info">
                        ${messageObj.userId === userId ? 'You' : `User ${messageObj.userNumber}`}<br>
                        ${time}
                    </div>
                    <div class="message-content">${escapeHtml(decryptedText)}</div>
                `;
            } else {
                // Try to decrypt
                decryptMessage(messageObj.encrypted, encryptionKey).then(text => {
                    messageEl.innerHTML = `
                        <div class="message-info">
                            ${messageObj.userId === userId ? 'You' : `User ${messageObj.userNumber}`}<br>
                            ${time}
                        </div>
                        <div class="message-content">${escapeHtml(text)}</div>
                    `;
                }).catch(() => {
                    messageEl.innerHTML = `
                        <div class="message-info">
                            ${messageObj.userId === userId ? 'You' : `User ${messageObj.userNumber}`}<br>
                            ${time}
                        </div>
                        <div class="message-content" style="font-style: italic; opacity: 0.6;">
                            [Encrypted message - wrong key?]
                        </div>
                    `;
                });
            }
            
            messagesEl.appendChild(messageEl);
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }

        // WebSocket connection
        let ws = null;
        
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${window.location.host}`);
            
            ws.onopen = () => {
                console.log('Connected to server');
                if (roomId && userId) {
                    ws.send(JSON.stringify({
                        type: 'join',
                        roomId: roomId,
                        userId: userId
                    }));
                }
            };
            
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                
                switch (data.type) {
                    case 'joined':
                        userId = data.userId;
                        userNumber = data.userNumber;
                        addSystemMessage(`You joined as User ${userNumber}`);
                        break;
                        
                    case 'messages':
                        // Display existing messages
                        data.messages.forEach(msg => {
                            if (!messages.find(m => m.id === msg.id)) {
                                messages.push(msg);
                                displayMessage(msg);
                            }
                        });
                        break;
                        
                    case 'message':
                        // New message from another user
                        if (!messages.find(m => m.id === data.message.id)) {
                            messages.push(data.message);
                            displayMessage(data.message);
                        }
                        break;
                        
                    case 'user_count':
                        updateUserCount(data.count);
                        break;
                        
                    case 'user_joined':
                        if (data.userNumber !== userNumber) {
                            addSystemMessage(`User ${data.userNumber} joined`);
                        }
                        break;
                        
                    case 'user_left':
                        addSystemMessage(`User ${data.userNumber} left`);
                        break;
                        
                    case 'error':
                        alert(data.message);
                        window.location.href = '/';
                        break;
                }
            };
            
            ws.onclose = () => {
                console.log('Disconnected from server');
                setTimeout(connectWebSocket, 3000); // Reconnect after 3 seconds
            };
            
            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
            };
        }

        // Encryption functions
        async function encryptMessage(message, key) {
            const encoder = new TextEncoder();
            const data = encoder.encode(message);
            
            const keyMaterial = await getKeyMaterial(key);
            const cryptoKey = await window.crypto.subtle.deriveKey(
                {
                    name: "PBKDF2",
                    salt: encoder.encode("static-salt"), // Use static salt for simplicity
                    iterations: 100000,
                    hash: "SHA-256"
                },
                keyMaterial,
                { name: "AES-GCM", length: 256 },
                false,
                ["encrypt", "decrypt"]
            );
            
            const iv = window.crypto.getRandomValues(new Uint8Array(12));
            const encrypted = await window.crypto.subtle.encrypt(
                { name: "AES-GCM", iv: iv },
                cryptoKey,
                data
            );
            
            const combined = new Uint8Array(iv.length + encrypted.byteLength);
            combined.set(iv);
            combined.set(new Uint8Array(encrypted), iv.length);
            
            return btoa(String.fromCharCode(...combined));
        }

        async function decryptMessage(encryptedBase64, key) {
            try {
                const encoder = new TextEncoder();
                const combined = Uint8Array.from(atob(encryptedBase64), c => c.charCodeAt(0));
                
                const iv = combined.slice(0, 12);
                const encrypted = combined.slice(12);
                
                const keyMaterial = await getKeyMaterial(key);
                const cryptoKey = await window.crypto.subtle.deriveKey(
                    {
                        name: "PBKDF2",
                        salt: encoder.encode("static-salt"),
                        iterations: 100000,
                        hash: "SHA-256"
                    },
                    keyMaterial,
                    { name: "AES-GCM", length: 256 },
                    false,
                    ["encrypt", "decrypt"]
                );
                
                const decrypted = await window.crypto.subtle.decrypt(
                    { name: "AES-GCM", iv: iv },
                    cryptoKey,
                    encrypted
                );
                
                return new TextDecoder().decode(decrypted);
            } catch (error) {
                throw new Error('Decryption failed');
            }
        }

        async function getKeyMaterial(password) {
            const encoder = new TextEncoder();
            return window.crypto.subtle.importKey(
                "raw",
                encoder.encode(password),
                "PBKDF2",
                false,
                ["deriveBits", "deriveKey"]
            );
        }

        // Helper functions
        function generateRoomId() {
            return Math.random().toString(36).substr(2, 9);
        }

        function generateUserId() {
            return Math.random().toString(36).substr(2, 9);
        }

        function updateUserCount(count = 1) {
            document.getElementById('userCount').textContent = `${count} user${count !== 1 ? 's' : ''}`;
        }

        function addSystemMessage(text) {
            const messagesEl = document.getElementById('messages');
            const messageEl = document.createElement('div');
            messageEl.className = 'system-message';
            messageEl.textContent = text;
            messagesEl.appendChild(messageEl);
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }

        function copyLink() {
            const link = document.getElementById('shareLink').textContent;
            navigator.clipboard.writeText(link);
            alert('Link copied to clipboard!');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Enter key to send
        document.getElementById('messageInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        document.getElementById('encryptionKey').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                setKey();
            }
        });
    </script>
</body>
</html>
